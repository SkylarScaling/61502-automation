---
  - name: Check for existing IDP
    command:
      argv:
        - rosa
        - list
        - idp
        - --cluster
        - "{{ cluster_name }}"
    register: idp_list

  - debug:
      msg: "{{ idp_list.stdout }}"

  - name: Delete IDP if it Already Exists
    command:
      argv:
        - rosa
        - delete
        - idp
        - "{{ name }}"
        - --cluster
        - "{{ cluster_name }}"
        - --yes
    when: name in idp_list.stdout

  - name: "Create 3M Active Directory LDAP Identity Provider"
    command:
      argv:
        - rosa
        - create
        - idp
        - --cluster
        - "{{ cluster_name }}"
        - --type
        - "{{ type }}"
        - --name
        - "{{ name }}"
        - --url
        - "{{ url }}"
        - --bind-password
        - "{{bind_password}}"
        - --bind-dn
        - "{{bind_dn}}"
        - --id-attributes
        - "{{id_attributes}}"
        - --name-attributes
        - "{{name_attributes}}"
        - --email-attributes
        - "{{email_attributes}}"
        - --username-attributes
        - "{{username_attributes}}"
    register: idp_provider

  - debug:
      msg: "{{idp_provider.stdout}}"
