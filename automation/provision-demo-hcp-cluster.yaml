---
- name: Provision OCP HCP Cluster on AWS
  gather_facts: false
  hosts: localhost
# Required Variables for this playbook
#    aws_account_id: xxxxxxxxx
#    account_roles_prefix: Managed-OpenShift
#    operator_roles_prefix: Managed-OpenShift-HCP
#    cluster_name: xxxxxxx
#    kms_arn: arn:aws:kms:xxxxxxxx
#    vpc_cidr: 10.0.0.0/16
#    subnet_id1: subnet-xxxxxxxxxxxxx
#    subnet_id2: subnet-xxxxxxxxxxxxx
#    subnet_id3: subnet-xxxxxxxxxxxxx
#    compute_machine_type: m5.xlarge
  tasks:
    - name: Set Public Subnet tags
      command:
        argv:
          - aws
          - ec2
          - create-tags
          - --resources
          - "{{ item }}"
          - --tags
          - Key=kubernetes.io/role/elb,Value=1
      loop:
        - "{{ public_subnet_id1 }}"
        - "{{ public_subnet_id2 }}"
        - "{{ public_subnet_id3 }}"

    - name: Set Private Subnet tags
      command:
        argv:
          - aws
          - ec2
          - create-tags
          - --resources
          - "{{ item }}"
          - --tags
          - Key=kubernetes.io/role/internal-elb,Value=1
      loop:
        - "{{ private_subnet_id1 }}"
        - "{{ private_subnet_id2 }}"
        - "{{ private_subnet_id3 }}"
      
    - name: Create ROSA Account-Wide IAM Roles
      command:
        argv:
          - rosa
          - create
          - account-roles
          - --hosted-cp
          - --prefix
          - Managed-OpenShift
          - --mode
          - auto
      register: account_roles

    - name: Get Returned Account Roles
      set_fact:
        arns: "{{account_roles.stdout}}"

    - name: Parse Worker, Installer, and Support Account Roles
      set_fact:
        worker_role: "{{ arns | regex_search('arn:aws\\S+Worker-Role') }}"
        installer_role: "{{ arns | regex_search('arn:aws\\S+Installer-Role') }}"
        support_role: "{{ arns | regex_search('arn:aws\\S+Support-Role') }}"

    - name: Create ROSA OIDC Configuration
      command:
        argv:
          - rosa
          - create
          - oidc-config
          - --mode
          - auto
          - --yes
      register: oidc_provider

    - name: Parse Returned OIDC Provider
      set_fact:
        oidc: "{{ oidc_provider.stdout | regex_search('[^/]+$') }}"

    - name: Get OIDC ID
      set_fact:
        oidc_id: "{{ oidc[:-1] }}"

    - name: Check if ROSA Operator Roles Exist
      command:
        argv:
          - rosa
          - list
          - operator-roles
          - --prefix
          - "{{ operator_roles_prefix | lower }}"
      register: existing_roles

    - name: Delete Existing ROSA Operator Roles
      command:
        argv:
          - rosa
          - delete
          - operator-roles
          - --prefix
          - "{{ operator_roles_prefix | lower }}"
          - -m
          - auto
          - -y
      when: existing_roles.stdout_lines | length > 1

    - name: Create ROSA Operator Roles
      command:
        argv:
          - rosa
          - create
          - operator-roles
          - --hosted-cp
          - --prefix
          - "{{ operator_roles_prefix }}"
          - --oidc-config-id
          - "{{ oidc_id }}"
          - --installer-role-arn
          - "arn:aws:iam::{{ aws_account_id }}:role/{{ account_roles_prefix }}-HCP-ROSA-Installer-Role"
          - --mode
          - auto
      register: operator_roles

    - name: Create ROSA HCP Cluster
      command:
        argv:
          - rosa
          - create
          - cluster
          - --cluster-name
          - "{{ cluster_name }}"
          - --hosted-cp
          - --sts
          - --mode
          - auto
          - --create-admin-user
          - --cluster-admin-password
          - "RedHat123RedHat123"
          - --operator-roles-prefix
          - "{{ operator_roles_prefix }}"
          - --oidc-config-id
          - "{{ oidc_id }}"
          - --subnet-ids
          - "{{ private_subnet_id1 + ',' + private_subnet_id2 + ',' + private_subnet_id3 + ',' + public_subnet_id1 + ',' + public_subnet_id2 + ',' + public_subnet_id3 }}"
          - --compute-machine-type
          - "{{ compute_machine_type }}"
      register: cluster_create

    - name: Cluster Creation Command Used
      debug:
        msg: "{{ cluster_create.cmd }}"

    - name: Cluster Creation Result
      debug:
        msg: "{{ cluster_create.stdout_lines }}"

    - name: Waiting for Cluster to Start (This will take several minutes...)
      command:
        argv:
          - rosa
          - logs
          - install
          - --cluster
          - "{{ cluster_name }}"
          - --watch
      register: logs_install

    - debug:
        msg: "{{ logs_install.stdout_lines }}"

#      rosa create cluster \
#      --cluster-name amjed \
#      --domain-prefix amjed \
#      --sts \
#      --cluster-admin-password l1nuX$1855adMn \
#      --role-arn arn:aws:iam::338512279495:role/amjed3m-HCP-ROSA-Installer-Role \
#      --support-role-arn arn:aws:iam::338512279495:role/amjed3m-HCP-ROSA-Support-Role \
#      --worker-iam-role arn:aws:iam::338512279495:role/amjed3m-HCP-ROSA-Worker-Role \
#      --operator-roles-prefix amjed3m \
#      --oidc-config-id 2csnndgi4br20ssd2319347r9a0qu849 \
#      --region us-east-1 \
#      --version 4.14.33 \
#      --replicas 3 \
#      --compute-machine-type m5.xlarge \
#      --machine-cidr 10.0.0.0/16 \
#      --service-cidr 172.30.0.0/16 \
#      --pod-cidr 10.128.0.0/14 \
#      --host-prefix 23 \
#      --subnet-ids subnet-0d61e3c282236e63e,subnet-037c9f25a5173e9d7,subnet-0a06533fa0a1a9369,subnet-0f5cda30cad9137b4,subnet-019a1f23f0db6bdbe,subnet-0d76cb73631535f29 \
#      --disable-workload-monitoring \
#      --hosted-cp \
#      --billing-account 338512279495

  # Enter the following command to follow the OpenShift installer logs to track the progress of the installation

  #  rosa logs install --cluster=${CLUSTER_NAME}  --watch

  # When the installation is completed take a screenshot of the result of the command , the screenshot must cover the below message that indicate the result of the installation:
  # I: Cluster '${CLUSTER_NAME} ' has been successfully installed
  # Paste the screenshot at the bottom of this document.

  # Additional tasks as appropriate:
#  Install the appropriate SSL/TLS certificate files on the server.
#  Create specific application configurations.
#  Configure application logging based on "type".